<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="æºç è§£æ,ReactNative," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="è‡ªä»Facebookæå‡ºäº†reactä¹‹åï¼Œè¿™ä¸ªæ¡†æ¶çš„å…³æ³¨åº¦ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œå®ƒæ‰€å¼•å…¥çš„ä¸€äº›ä¸œè¥¿è¿˜æ˜¯å€¼å¾—å­¦ä¹ ï¼Œæ¯”å¦‚ç»„ä»¶åŒ–çš„å¼€å‘æ–¹å¼ï¼Œvirtual domçš„æ€§èƒ½æå‡æ–¹å¼ç­‰ï¼Œæœ€è¿‘ä¸ºäº†æ”¹è¿›ç°æœ‰çš„è·¨å¹³å°æ–¹æ¡ˆä¹Ÿåœ¨ç ”ç©¶reactï¼Œåœ¨è¿™è¾¹ä¹Ÿåšä¸‹ç›¸å…³çš„è®°å½•ã€‚
####preåœ¨å¼€å§‹ä½¿ç”¨reactä¹‹å‰æˆ‘ä»¬éœ€è¦æ­å»ºç›¸åº”çš„ç¯å¢ƒï¼Œè¿™ä¸ªå°±ä¸åœ¨æ¢è®¨äº†ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºreactéœ€è¦ä½¿ç”¨javascriptè¯­è¨€ï¼Œæ‰€ä»¥å¯èƒ½éœ€">
<meta property="og:type" content="article">
<meta property="og:title" content="æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰">
<meta property="og:url" content="http://freemind-lj.github.io/2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/index.html">
<meta property="og:site_name" content="æ ‘ä¸‹çš„è€ç”·å­©">
<meta property="og:description" content="è‡ªä»Facebookæå‡ºäº†reactä¹‹åï¼Œè¿™ä¸ªæ¡†æ¶çš„å…³æ³¨åº¦ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œå®ƒæ‰€å¼•å…¥çš„ä¸€äº›ä¸œè¥¿è¿˜æ˜¯å€¼å¾—å­¦ä¹ ï¼Œæ¯”å¦‚ç»„ä»¶åŒ–çš„å¼€å‘æ–¹å¼ï¼Œvirtual domçš„æ€§èƒ½æå‡æ–¹å¼ç­‰ï¼Œæœ€è¿‘ä¸ºäº†æ”¹è¿›ç°æœ‰çš„è·¨å¹³å°æ–¹æ¡ˆä¹Ÿåœ¨ç ”ç©¶reactï¼Œåœ¨è¿™è¾¹ä¹Ÿåšä¸‹ç›¸å…³çš„è®°å½•ã€‚
####preåœ¨å¼€å§‹ä½¿ç”¨reactä¹‹å‰æˆ‘ä»¬éœ€è¦æ­å»ºç›¸åº”çš„ç¯å¢ƒï¼Œè¿™ä¸ªå°±ä¸åœ¨æ¢è®¨äº†ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºreactéœ€è¦ä½¿ç”¨javascriptè¯­è¨€ï¼Œæ‰€ä»¥å¯èƒ½éœ€">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-15c5ec5d168c8861.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-b6a9b19b0a599340.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-f4d94de13f071752.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/aaaaa.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-55517b729679058d.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-55bd1d087f5b19af.png">
<meta property="og:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/bbbbb.png">
<meta property="og:updated_time" content="2016-04-07T11:46:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰">
<meta name="twitter:description" content="è‡ªä»Facebookæå‡ºäº†reactä¹‹åï¼Œè¿™ä¸ªæ¡†æ¶çš„å…³æ³¨åº¦ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œå®ƒæ‰€å¼•å…¥çš„ä¸€äº›ä¸œè¥¿è¿˜æ˜¯å€¼å¾—å­¦ä¹ ï¼Œæ¯”å¦‚ç»„ä»¶åŒ–çš„å¼€å‘æ–¹å¼ï¼Œvirtual domçš„æ€§èƒ½æå‡æ–¹å¼ç­‰ï¼Œæœ€è¿‘ä¸ºäº†æ”¹è¿›ç°æœ‰çš„è·¨å¹³å°æ–¹æ¡ˆä¹Ÿåœ¨ç ”ç©¶reactï¼Œåœ¨è¿™è¾¹ä¹Ÿåšä¸‹ç›¸å…³çš„è®°å½•ã€‚
####preåœ¨å¼€å§‹ä½¿ç”¨reactä¹‹å‰æˆ‘ä»¬éœ€è¦æ­å»ºç›¸åº”çš„ç¯å¢ƒï¼Œè¿™ä¸ªå°±ä¸åœ¨æ¢è®¨äº†ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç”±äºreactéœ€è¦ä½¿ç”¨javascriptè¯­è¨€ï¼Œæ‰€ä»¥å¯èƒ½éœ€">
<meta name="twitter:image" content="http://7xpjm0.com1.z0.glb.clouddn.com/458529-15c5ec5d168c8861.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>

  <title> æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰ | æ ‘ä¸‹çš„è€ç”·å­© </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?13f1b84fb89c93c6c9b314ad1c03d8d0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">æ ‘ä¸‹çš„è€ç”·å­©</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">å·¥åŒ ä¹‹è¡Œï¼Œåœ¨è¡ŒåŠ¨ä¸­ä½“æ‚Ÿä¿®è¡Œçš„ä¹è¶£</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tech">
          <a href="/categories/tech/" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            æŠ€æœ¯
          </a>
        </li>
      
        
        <li class="menu-item menu-item-others">
          <a href="/categories/others/" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            å…¶å®ƒ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2016-03-14T19:38:44+08:00" content="2016-03-14">
              2016-03-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/tech/" itemprop="url" rel="index">
                    <span itemprop="name">tech</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/" class="leancloud_visitors" data-flag-title="æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•° </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="http://7xpjm0.com1.z0.glb.clouddn.com/458529-15c5ec5d168c8861.png" alt=""><br>è‡ªä»Facebookæå‡ºäº†reactä¹‹åï¼Œè¿™ä¸ªæ¡†æ¶çš„å…³æ³¨åº¦ä¸€ç›´å±…é«˜ä¸ä¸‹ï¼Œå®ƒæ‰€å¼•å…¥çš„ä¸€äº›ä¸œè¥¿è¿˜æ˜¯å€¼å¾—å­¦ä¹ ï¼Œæ¯”å¦‚ç»„ä»¶åŒ–çš„å¼€å‘æ–¹å¼ï¼Œvirtual domçš„æ€§èƒ½æå‡æ–¹å¼ç­‰ï¼Œæœ€è¿‘ä¸ºäº†æ”¹è¿›ç°æœ‰çš„è·¨å¹³å°æ–¹æ¡ˆä¹Ÿåœ¨ç ”ç©¶reactï¼Œåœ¨è¿™è¾¹ä¹Ÿåšä¸‹ç›¸å…³çš„è®°å½•ã€‚</p>
<p>####pre<br>åœ¨å¼€å§‹ä½¿ç”¨reactä¹‹å‰æˆ‘ä»¬éœ€è¦æ­å»ºç›¸åº”çš„ç¯å¢ƒï¼Œè¿™ä¸ªå°±ä¸åœ¨æ¢è®¨äº†ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹<a href="http://reactnative.cn/docs/0.20/getting-started.html" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ï¼Œç”±äºreactéœ€è¦ä½¿ç”¨javascriptè¯­è¨€ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦å»ç®€å•äº†è§£ä¸€ä¸‹ç›¸å…³çš„è¯­æ³•(æ¯”å¦‚ï¼š<a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ES6 æ ‡å‡†å…¥é—¨</a>)ï¼Œå¦å¤–iOSåœ¨7.0ä¹‹åå¼•å…¥äº†javascriptcoreæ¡†æ¶ï¼Œæå¤§çš„æ–¹ä¾¿äº†jsè·Ÿocä¹‹é—´deé€šä¿¡ï¼Œä¹‹å‰æœ‰ä¸€ç¯‡<a href="http://www.jianshu.com/p/1328e15416f3" target="_blank" rel="external">åšå®¢</a>ç®€å•çš„ä»‹ç»äº†javascriptcoreï¼Œæœ‰å…´è¶£çš„ä¹Ÿå¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚</p>
<p>####æ•´ä½“æ¡†æ¶<br>reactçš„æ•´ä½“ç¤ºæ„å›¾å¯ä»¥ç”¨ä¸‹é¢å›¾è¡¨ç¤ºï¼Œæˆ‘ä»¬æ‰€ç¼–å†™çš„jsä»£ç å¯ä»¥åœ¨å„ä¸ªå¹³å°ä¸Šè¿è¡Œï¼Œè¿™è®©æˆ‘ä»¬æœ‰webçš„å¼€å‘æ•ˆç‡çš„åŒæ—¶åˆæœ‰äº†åŸç”Ÿåº”ç”¨çš„ä½“éªŒã€‚</p>
<p><img src="http://7xpjm0.com1.z0.glb.clouddn.com/458529-b6a9b19b0a599340.png" alt="Learn once, write anywhere"><br>ä¸è¿‡è¿™é‡Œé¢åŒ…å«çš„ä¸œè¥¿å¯¹äºæœ‰ç‚¹å¤šï¼Œå°¤å…¶å¾ˆå¤šwebç›¸å…³çš„ä¸œè¥¿å¯¹äºæ²¡æ¥è§¦è¿‡çš„äººè¿˜æ˜¯æœ‰äº›éš¾åº¦çš„ï¼Œè¦æƒ³å¿«é€Ÿçš„ç ”ç©¶é€å½»å¯èƒ½ä¸å¤ªç°å®ï¼Œè‡³å°‘å¯¹äºæˆ‘æ˜¯è¿™æ ·çš„ï¼Œå› æ­¤æˆ‘ä»¬é¦–å…ˆç ”ç©¶ä¸€ä¸‹reactä¸­jsè·Ÿnativeä¹‹é—´çš„é€šä¿¡æ–¹æ³•ï¼Œå…¶å®ƒçš„æœ‰å¾…åé¢åœ¨åˆ†æã€‚</p>
<a id="more"></a>
<p>å‡è®¾ä½ å·²ç»æ­å»ºå¥½ç›¸å…³ç¯å¢ƒï¼Œé€šè¿‡ä¸‹é¢çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°å·¥ç¨‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native init TestDemo</span><br></pre></td></tr></table></figure></p>
<p>è¿è¡Œxcodeprojå·¥ç¨‹ï¼ŒXcodeåœ¨ç¼–è¯‘å®Œåä¼šæ‰§è¡Œæ‰“åŒ…è„šæœ¬ï¼Œå°†jsæ–‡ä»¶éƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªmain.jsbundleæ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å°†è¯¥æ–‡ä»¶æ”¾åˆ°æœåŠ¡å™¨ä¸Šæˆ–è€…åº”ç”¨å†…éƒ¨ï¼Œå¦‚æœæ”¾åˆ°æœåŠ¡å™¨ä¸Šéœ€è¦å…ˆä¸‹è½½è¯¥æ–‡ä»¶ï¼Œæ¥ç€åŠ è½½æ‰§è¡Œè¯¥æ–‡ä»¶å¯ä»¥çœ‹åˆ°demoé¡µé¢äº†ã€‚</p>
<p><img src="http://7xpjm0.com1.z0.glb.clouddn.com/458529-f4d94de13f071752.png" alt="packager"><br><img src="http://7xpjm0.com1.z0.glb.clouddn.com/aaaaa.png" alt="demo"></p>
<p>####é€šä¿¡è¿‡ç¨‹<br>â€ƒâ€ƒæ‰€è°“çš„é€šä¿¡å…¶å®å°±æ˜¯jså’Œocä¸¤è€…å¦‚ä½•ç›¸äº’è°ƒç”¨ä¼ å‚ç­‰ï¼Œä¸ºäº†æ›´æ–¹ä¾¿çš„æ­ç¤ºä¸¤è€…çš„é€šä¿¡è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®messagequeue.jsæ–‡ä»¶ä¸­çš„SPY_MODEæ ‡å¿—ä¸ºtrueï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//MessageQueue.jsï¼Œéœ€è¦å¤„äºdevæ¨¡å¼</span><br><span class="line">//http://localhost:8081/index.ios.bundle?platform=ios&amp;dev=trueä¸ºtrue</span><br><span class="line">let SPY_MODE = true; //</span><br></pre></td></tr></table></figure></p>
<p>â€ƒâ€ƒç°åœ¨é‡æ–°reload jsä½ å°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„æ—¥å¿—è¾“å‡ºï¼Œä¸‹é¢çš„æ—¥å¿—å¯ä»¥æ¯”è¾ƒç›´è§‚çš„æ­ç¤ºä¸¤è€…çš„è°ƒç”¨æ–¹å¼ï¼Œâ€™JS-&gt;Nâ€™å³JSè°ƒç”¨nativeä»£ç ï¼Œåä¹‹äº¦ç„¶ã€‚å¯ä»¥çœ‹åˆ°ç¨‹åºä¸€å¼€å§‹nativeä¼šè°ƒç”¨jsçš„RCTDeviceEventEmitter.emitæ–¹æ³•ï¼Œåˆ†åˆ«å‘é€â€™appStateDidChangeâ€™ å’Œâ€™networkStatusDidChangeâ€™ä¸¤ä¸ªäº‹ä»¶ï¼Œæ¥ç€è°ƒç”¨jsçš„AppRegistry.runApplicationæ–¹æ³•å¯åŠ¨jsåº”ç”¨ï¼Œç„¶åjså±‚å°±å¯ä»¥é€šè¿‡nativeæä¾›çš„æ–¹æ³•æ¥ RCTUIManager.createViewæ¥åˆ›å»ºè§†å›¾äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">N-&gt;JS : RCTDeviceEventEmitter.emit([&quot;appStateDidChange&quot;,&#123;&quot;app_state&quot;:&quot;active&quot;&#125;])</span><br><span class="line">N-&gt;JS : RCTDeviceEventEmitter.emit([&quot;networkStatusDidChange&quot;,&#123;&quot;network_info&quot;:&quot;wifi&quot;&#125;])</span><br><span class="line">N-&gt;JS : AppRegistry.runApplication([&quot;TestDemo&quot;,&#123;&quot;rootTag&quot;:1,&quot;initialProps&quot;:&#123;&#125;&#125;])</span><br><span class="line">Running application &quot;TestDemo&quot; with appParams: &#123;&quot;rootTag&quot;:1,&quot;initialProps&quot;:&#123;&#125;&#125;. __DEV__ === true, development-level warning are ON, performance optimizations are OFF</span><br><span class="line">JS-&gt;N : RCTUIManager.createView([2,&quot;RCTView&quot;,1,&#123;&quot;flex&quot;:1&#125;])</span><br><span class="line">JS-&gt;N : RCTUIManager.createView([3,&quot;RCTView&quot;,1,&#123;&quot;flex&quot;:1&#125;])</span><br><span class="line">JS-&gt;N : RCTUIManager.createView([4,&quot;RCTView&quot;,1,&#123;&quot;flex&quot;:1,&quot;justifyContent&quot;:&quot;center&quot;,&quot;alignItems&quot;:&quot;center&quot;,&quot;backgroundColor&quot;:4294311167&#125;])</span><br><span class="line">S-&gt;N : RCTUIManager.createView([5,&quot;RCTText&quot;,1,&#123;&quot;fontSize&quot;:20,&quot;textAlign&quot;:&quot;center&quot;,&quot;margin&quot;:10,&quot;accessible&quot;:true,&quot;allowFontScaling&quot;:true&#125;])</span><br><span class="line">JS-&gt;N : RCTUIManager.createView([6,&quot;RCTRawText&quot;,1,&#123;&quot;text&quot;:&quot;Welcome to React Native!&quot;&#125;])</span><br><span class="line">JS-&gt;N : RCTUIManager.setChildren([5,[6]])</span><br></pre></td></tr></table></figure></p>
<h5 id="JS-gt-Nativeï¼ŒJSè°ƒç”¨Native"><a href="#JS-gt-Nativeï¼ŒJSè°ƒç”¨Native" class="headerlink" title="JS-&gt;Nativeï¼ŒJSè°ƒç”¨Native"></a>JS-&gt;Nativeï¼ŒJSè°ƒç”¨Native</h5><p>è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹nativeå¦‚ä½•åˆ›å»ºä¸€ä¸ªæ¨¡å—ç„¶åæš´éœ²ç»™jså±‚è°ƒç”¨çš„ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒ<a href="http://reactnative.cn/docs/0.21/native-modules-ios.html#content" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæˆ‘ä»¬è¿™é‡Œä¸¾ä¸ªç®€å•çš„ğŸŒ°ï¼Œåˆ›å»ºä¸€ä¸ªMyModuleæ¨¡å—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@interface MyModule : NSObject &lt;RCTBridgeModule&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation MyModule</span><br><span class="line"></span><br><span class="line">RCT_EXPORT_MODULE();</span><br><span class="line"></span><br><span class="line">RCT_EXPORT_METHOD(addEvent:(NSString *)name location:(NSString *)location)</span><br><span class="line">&#123;</span><br><span class="line">  RCTLogInfo(@&quot;add an event %@ at %@&quot;, name, location);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¿™ä¸Šé¢çš„ä¸¤ä¸ªå®å®šä¹‰ï¼š</p>
<ul>
<li>RCT_EXPORT_MODULE()<br>åœ¨nativeå±‚åˆ›å»ºçš„æ¨¡å—éœ€è¦é€šè¿‡è¿™ä¸ªå®å®šä¹‰å°†è¯¥æ¨¡å—æš´éœ²ç»™jsï¼Œè¯¥å®å®šä¹‰çš„å…·ä½“å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define RCT_EXPORT_MODULE(js_name) \</span><br><span class="line">RCT_EXTERN void RCTRegisterModule(Class); \</span><br><span class="line">+ (NSString *)moduleName &#123; return @#js_name; &#125; \</span><br><span class="line">+ (void)load &#123; RCTRegisterModule(self); &#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå®ƒå°†RCTRegisterModuleè¿™ä¸ªå‡½æ•°å®šä¹‰ä¸ºexternï¼Œè¿™æ ·è¯¥å‡½æ•°çš„å®ç°å¯¹ç¼–è¯‘å™¨ä¸å¯è§ï¼Œä½†ä¼šåœ¨é“¾æ¥çš„æ—¶å€™å¯ä»¥è·å–åˆ°ï¼›åŒæ—¶å£°æ˜ä¸€ä¸ªmoduleNameå‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›è¯¥æ¨¡å—çš„jsåç§°ï¼Œå¦‚æœä½ æ²¡æœ‰æŒ‡å®šï¼Œé»˜è®¤ä½¿ç”¨ç±»åï¼›æœ€åå£°æ˜ä¸€ä¸ªloadå‡½æ•°ï¼ˆå½“åº”ç”¨è½½å…¥åä¼šåŠ è½½æ‰€æœ‰çš„ç±»ï¼Œloadå‡½æ•°åœ¨ç±»åˆå§‹åŒ–åŠ è½½çš„æ—¶å€™å°±è°ƒç”¨ï¼‰ï¼Œç„¶åè°ƒç”¨RCTRegisterModuleå‡½æ•°æ³¨å†Œè¯¥æ¨¡å—ï¼Œè¯¥æ¨¡å—ä¼šè¢«æ³¨å†Œæ·»åŠ åˆ°ä¸€ä¸ªå…¨å±€çš„æ•°ç»„RCTModuleClassesä¸­ã€‚</p>
<ul>
<li>RCT_EXPORT_METHOD()<br>è¦æš´éœ²ç»™jsè°ƒç”¨çš„APIæ¥å£éœ€è¦é€šè¿‡è¯¥å®å®šä¹‰å£°æ˜ï¼Œè¯¥å®å®šä¹‰ä¼šé¢å¤–åˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œå½¢å¼å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (NSArray *)__rct_export__230</span><br><span class="line">&#123;</span><br><span class="line">  return @[ @&quot;&quot;, @&quot;addEvent:(NSString *)name location:(NSString *)location&quot; ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°åç§°ä»¥   <strong>rct_export</strong> å¼€å¤´ï¼ŒåŒæ—¶åŠ ä¸Šè¯¥å‡½æ•°æ‰€åœ¨çš„ä»£ç è¡Œæ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªåŒ…å«å¯é€‰çš„jsåç§°ä»¥åŠä¸€ä¸ªå‡½æ•°ç­¾åçš„æ•°ç»„ï¼Œä»–ä»¬çš„ä½œç”¨åé¢ä¼šè¯´åˆ°ã€‚</p>
<ul>
<li>RCTBatchedBridge<br>ä¸ºäº†æ¡¥æ¥jsè·Ÿnativeï¼Œnativeå±‚å¼•å…¥äº†RCTBridgeè¿™ä¸ªç±»è´Ÿè´£åŒæ–¹çš„é€šä¿¡ï¼Œä¸è¿‡çœŸæ­£èµ·ä½œç”¨çš„æ˜¯RCTBatchedBridgeè¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»åº”è¯¥ç®—æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªç±»äº†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªç±»ä¸»è¦åšå•¥äº‹æƒ…ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">//RCTBatchedBridge.m</span><br><span class="line">- (void)start</span><br><span class="line">&#123;</span><br><span class="line">  dispatch_queue_t bridgeQueue = dispatch_queue_create(&quot;com.facebook.react.RCTBridgeQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">  // å¼‚æ­¥çš„åŠ è½½æ‰“åŒ…å®Œæˆçš„jsæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯main.jsbundleï¼Œå¦‚æœåŒ…æ–‡ä»¶åœ¨æœ¬åœ°åˆ™ç›´æ¥åŠ è½½ï¼Œå¦åˆ™æ ¹æ®URLé€šè¿‡NSURLSessionæ–¹å¼å»ä¸‹è½½</span><br><span class="line">  [self loadSource:^(NSError *error, NSData *source) &#123;&#125;];</span><br><span class="line"></span><br><span class="line">  // åŒæ­¥åˆå§‹åŒ–éœ€è¦æš´éœ²ç»™ç»™jså±‚çš„nativeæ¨¡å—</span><br><span class="line">  [self initModules];</span><br><span class="line"></span><br><span class="line">  //å¼‚æ­¥åˆå§‹åŒ–JS Executorï¼Œä¹Ÿå°±æ˜¯jså¼•æ“</span><br><span class="line">  dispatch_group_async(setupJSExecutorAndModuleConfig, bridgeQueue, ^&#123;</span><br><span class="line">    [weakSelf setUpExecutor];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  //å¼‚æ­¥è·å–å„ä¸ªæ¨¡å—çš„é…ç½®ä¿¡æ¯</span><br><span class="line">  dispatch_group_async(setupJSExecutorAndModuleConfig, bridgeQueue, ^&#123;</span><br><span class="line">    config = [weakSelf moduleConfig];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  //è·å–å„æ¨¡å—çš„é…ç½®ä¿¡æ¯åï¼Œå°†è¿™äº›ä¿¡æ¯æ³¨å…¥åˆ°JSç¯å¢ƒä¸­</span><br><span class="line">  [self injectJSONConfiguration:config onComplete:^(NSError *error) &#123;&#125;];</span><br><span class="line"></span><br><span class="line">  //å¼€å§‹æ‰§è¡Œmain.jsbundle</span><br><span class="line">  [self executeSourceCode:sourceCode];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•è§£é‡Šä¸€ä¸‹å…¶ä¸­å‡ ä¸ªæ­¥éª¤çš„å…·ä½“å†…å®¹ï¼š</p>
<h6 id="initModules"><a href="#initModules" class="headerlink" title="initModules"></a>initModules</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (void)initModules</span><br><span class="line">&#123;</span><br><span class="line">  NSMutableArray&lt;RCTModuleData *&gt; *moduleDataByID = [NSMutableArray new];</span><br><span class="line">  NSMutableDictionary&lt;NSString *, RCTModuleData *&gt; *moduleDataByName = [NSMutableDictionary new];</span><br><span class="line">  SEL setBridgeSelector = NSSelectorFromString(@&quot;setBridge:&quot;);</span><br><span class="line">  IMP objectInitMethod = [NSObject instanceMethodForSelector:@selector(init)];</span><br><span class="line"></span><br><span class="line">  //RCTGetModuleClasses()è¿”å›ä¹‹å‰æåˆ°çš„å…¨å±€RCTModuleClassesæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯æ¨¡å—ç±»loadæ—¶å€™ä¼šæ³¨å†Œæ·»åŠ çš„æ•°ç»„</span><br><span class="line">  for (Class moduleClass in RCTGetModuleClasses()) &#123;</span><br><span class="line">    NSString *moduleName = RCTBridgeModuleNameForClass(moduleClass);</span><br><span class="line">    //å¦‚æœè¯¥ç±»æˆ–è€…çˆ¶ç±»æ²¡æœ‰é‡å†™äº†initæ–¹æ³•æˆ–å®ç°äº†setBridgeæ–¹æ³•ï¼Œåˆ™ï¼Œåˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹</span><br><span class="line">    //Reactè®¤ä¸ºå¼€å‘è€…æœŸæœ›è¿™ä¸ªæ¨¡å—åœ¨bridgeç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶ä¼šå®ä¾‹åŒ–ï¼Œç¡®ä¿è¯¥æ¨¡å—åªæœ‰ä¸€ä¸ªå®ä¾‹å¯¹è±¡</span><br><span class="line">    if ([moduleClass instanceMethodForSelector:@selector(init)] != objectInitMethod ||</span><br><span class="line">        [moduleClass instancesRespondToSelector:setBridgeSelector]) &#123;</span><br><span class="line">      module = [moduleClass new];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //åˆ›å»ºRCTModuleDataæ¨¡å—ä¿¡æ¯ï¼Œå¹¶ä¿å­˜åˆ°æ•°ç»„ä¸­</span><br><span class="line">    RCTModuleData *moduleData;</span><br><span class="line">    if (module) &#123;</span><br><span class="line">      if (module != (id)kCFNull) &#123;</span><br><span class="line">        moduleData = [[RCTModuleData alloc] initWithModuleInstance:module</span><br><span class="line">                                                            bridge:self];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    moduleDataByName[moduleName] = moduleData;</span><br><span class="line">    [moduleDataByID addObject:moduleData];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“åˆ›å»ºå®Œæ¨¡å—çš„å®ä¾‹å¯¹è±¡ä¹‹åï¼Œä¼šå°†è¯¥å®ä¾‹ä¿å­˜åˆ°ä¸€ä¸ªRCTModuleDataå¯¹è±¡ä¸­ï¼ŒRCTModuleDataé‡ŒåŒ…å«æ¨¡å—çš„ç±»åï¼Œåç§°ï¼Œæ–¹æ³•åˆ—è¡¨ï¼Œå®ä¾‹å¯¹è±¡ã€è¯¥æ¨¡å—ä»£ç æ‰§è¡Œçš„é˜Ÿåˆ—ä»¥åŠé…ç½®ä¿¡æ¯ç­‰ï¼Œjså±‚å°±æ˜¯æ ¹æ®è¿™ä¸ªå¯¹è±¡æ¥æŸ¥è¯¢è¯¥æ¨¡å—çš„ç›¸å…³ä¿¡æ¯ã€‚</p>
<h6 id="setUpExecutor"><a href="#setUpExecutor" class="headerlink" title="setUpExecutor"></a>setUpExecutor</h6><p>reactnativeçš„jså¼•æ“åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§è·Ÿä¸»çº¿å±‚çš„ä¼˜å…ˆçº§ä¸€æ ·ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªrunloopï¼Œè¿™æ ·çº¿ç¨‹æ‰èƒ½å¾ªç¯æ‰§è¡Œä¸ä¼šé€€å‡ºã€‚æ‰€ä»¥æ‰§è¡Œjsä»£ç ä¸ä¼šå½±å“åˆ°ä¸»çº¿ç¨‹ï¼Œè€Œä¸”RCTJSCExecutorä½¿ç”¨çš„æ˜¯JavaScriptCoreæ¡†æ¶ï¼Œæ‰€ä»¥reactåªæ”¯æŒiOS7åŠä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//RCTJSCExecutor.m</span><br><span class="line">- (instancetype)init</span><br><span class="line">&#123;</span><br><span class="line">  NSThread *javaScriptThread = [[NSThread alloc] initWithTarget:[self class]</span><br><span class="line">                                                       selector:@selector(runRunLoopThread)</span><br><span class="line">                                                         object:nil];</span><br><span class="line">  javaScriptThread.name = @&quot;com.facebook.React.JavaScript&quot;;</span><br><span class="line">  //è®¾ç½®è¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§å¤„äºé«˜ä¼˜å…ˆçº§</span><br><span class="line">  if ([javaScriptThread respondsToSelector:@selector(setQualityOfService:)]) &#123;</span><br><span class="line">    [javaScriptThread setQualityOfService:NSOperationQualityOfServiceUserInteractive];</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    javaScriptThread.threadPriority = [NSThread mainThread].threadPriority;</span><br><span class="line">  &#125;</span><br><span class="line">  [javaScriptThread start];</span><br><span class="line">  return [self initWithJavaScriptThread:javaScriptThread context:nil];</span><br><span class="line">&#125;</span><br><span class="line">- (void)addSynchronousHookWithName:(NSString *)name usingBlock:(id)block</span><br><span class="line">&#123;</span><br><span class="line">  __weak RCTJSCExecutor *weakSelf = self;</span><br><span class="line">  [self executeBlockOnJavaScriptQueue:^&#123;</span><br><span class="line">    //å°†è¯¥blockå‡½æ•°æ·»åŠ åˆ°jsçš„contextä¸­ï¼Œjavascriptcoreä¼šå°†blockå‡½æ•°è½¬æˆjs function</span><br><span class="line">    weakSelf.context.context[name] = block;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setUp</span><br><span class="line">&#123;</span><br><span class="line">  [self addSynchronousHookWithName:@&quot;noop&quot; usingBlock:^&#123;&#125;];</span><br><span class="line">  [self addSynchronousHookWithName:@&quot;nativeRequireModuleConfig&quot; usingBlock:^NSString *(NSString *moduleName) &#123;</span><br><span class="line">    //è·å–è¯¥æ¨¡å—çš„å…·ä½“é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«æ–¹æ³•ä»¥åŠå¯¼å‡ºçš„å¸¸é‡ç­‰ä¿¡æ¯</span><br><span class="line">    NSArray *config = [strongSelf-&gt;_bridge configForModuleName:moduleName];</span><br><span class="line">    NSString *result = config ? RCTJSONStringify(config, NULL) : nil;</span><br><span class="line">    return result;</span><br><span class="line">  &#125;];</span><br><span class="line">  [self addSynchronousHookWithName:@&quot;nativeFlushQueueImmediate&quot; usingBlock:^(NSArray&lt;NSArray *&gt; *calls)&#123;</span><br><span class="line">    [strongSelf-&gt;_bridge handleBuffer:calls batchEnded:NO];</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°setupçš„æ—¶å€™ä¼šæ³¨å†Œå‡ ä¸ªæ–¹æ³•åˆ°jsçš„ä¸Šä¸‹æ–‡ä¸­ä¾›åé¢jsè°ƒç”¨ï¼Œæ¯”å¦‚â€™nativeFlushQueueImmediateâ€™ å’Œ â€˜nativeRequireModuleConfigâ€™æ–¹æ³•ç­‰ï¼Œå½“jsè°ƒç”¨ç›¸åº”æ–¹æ³•æ—¶ä¼šæ‰§è¡Œå¯¹åº”çš„blockï¼Œjavascriptcoreæ¡†æ¶ä¼šè´Ÿè´£js functionå’Œblockçš„è½¬æ¢ã€‚</p>
<h6 id="moduleConfig"><a href="#moduleConfig" class="headerlink" title="moduleConfig"></a>moduleConfig</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- (NSString *)moduleConfig</span><br><span class="line">&#123;</span><br><span class="line">  NSMutableArray&lt;NSArray *&gt; *config = [NSMutableArray new];</span><br><span class="line">  for (RCTModuleData *moduleData in _moduleDataByID) &#123;</span><br><span class="line">    [config addObject:@[moduleData.name]]; </span><br><span class="line">  &#125;</span><br><span class="line">  return RCTJSONStringify(@&#123;</span><br><span class="line">    @&quot;remoteModuleConfig&quot;: config,</span><br><span class="line">  &#125;, NULL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»å®ç°å¯ä»¥çœ‹å‡ºä»…ä»…è¯¥è¿‡ç¨‹æ˜¯å°†æ¨¡å—çš„åç§°ä¿å­˜åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªjsonå­—ç¬¦ä¸²çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«æ‰€æœ‰çš„æ¨¡å—åç§°ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;remoteModuleConfig&quot;:[[&quot;MyModule&quot;],[&quot;RCTStatusBarManager&quot;],[&quot;RCTSourceCode&quot;],[&quot;RCTAlertManager&quot;],[&quot;RCTExceptionsManager&quot;],...]&#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="injectJSONConfiguration"><a href="#injectJSONConfiguration" class="headerlink" title="injectJSONConfiguration"></a>injectJSONConfiguration</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)injectJSONConfiguration:(NSString *)configJSON</span><br><span class="line">                     onComplete:(void (^)(NSError *))onComplete</span><br><span class="line">&#123;</span><br><span class="line">  [_javaScriptExecutor injectJSONText:configJSON</span><br><span class="line">                  asGlobalObjectNamed:@&quot;__fbBatchedBridgeConfig&quot;</span><br><span class="line">                             callback:onComplete];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ç”Ÿæˆé…ç½®ä¿¡æ¯ä¹‹åï¼Œé€šè¿‡ä¸Šé¢çš„å‡½æ•°å°†è¯¥jsonä¿¡æ¯ä¿å­˜åˆ°jsçš„å…¨å±€å¯¹è±¡__fbBatchedBridgeConfigä¸­ï¼Œè¿™æ ·jså±‚å°±å¯ä»¥çŸ¥é“æˆ‘ä»¬æä¾›äº†å“ªäº›æ¨¡å—ï¼Œä¸è¿‡ç»†å¿ƒçš„è¯ä½ å¯èƒ½ä¼šå‘ç°ç»™jsçš„ä¿¡æ¯åªæœ‰è¿™äº›æ¨¡å—çš„åç§°ï¼Œé‚£jsæ€ä¹ˆè°ƒç”¨nativeçš„æ–¹æ³•çš„ï¼Œå…¶å®è¿™æ˜¯reactä¸ºäº†æ‡’åŠ è½½è€Œé‡‡ç”¨çš„æ–¹å¼ï¼Œå…·ä½“æˆ‘ä»¬ä¸‹é¢è¯´æ˜ã€‚</p>
<p>å½“æˆ‘ä»¬é…ç½®å¥½nativeæ¨¡å—åï¼Œjså±‚è¦æƒ³è°ƒç”¨è¯¥nativeæ¨¡å—çš„æ–¹æ³•å¦‚ä¸‹ç¤ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var myModule = require(&apos;react-native&apos;).NativeModules.MyModule;</span><br><span class="line">myModule.addEvent(&apos;Birthday Party&apos;, &apos;4 Privet Drive, Surrey&apos;);</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹å‡ºnativeæ¨¡å—æ˜¯ä¿å­˜åœ¨NativeModulesä¸­ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ°NativeModules.jsæ–‡ä»¶ä¸­çœ‹çœ‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const BatchedBridge = require(&apos;BatchedBridge&apos;);</span><br><span class="line">const RemoteModules = BatchedBridge.RemoteModules;</span><br><span class="line">const NativeModules = &#123;&#125;;</span><br><span class="line">Object.keys(RemoteModules).forEach((moduleName) =&gt; &#123;</span><br><span class="line">  Object.defineProperty(NativeModules, moduleName, &#123;</span><br><span class="line">    enumerable: true,</span><br><span class="line">    //æ‡’åŠ è½½æ–¹å¼</span><br><span class="line">    get: () =&gt; &#123;</span><br><span class="line">      let module = RemoteModules[moduleName];</span><br><span class="line">      if (module &amp;&amp; typeof module.moduleID === &apos;number&apos; &amp;&amp; global.nativeRequireModuleConfig) &#123;</span><br><span class="line"></span><br><span class="line">        //ä»nativeå±‚è·å–è¯¥æ¨¡å—çš„å…·ä½“é…ç½®ä¿¡æ¯ï¼ŒnativeRequireModuleConfigæ˜¯ä¹‹å‰æ³¨å†Œåˆ°js globalå¯¹è±¡çš„æ–¹æ³•ï¼Œç„¶åæŠŠconfigä¿¡æ¯äº¤ç»™BatchedBridgeå¤„ç†</span><br><span class="line">        const json = global.nativeRequireModuleConfig(moduleName);</span><br><span class="line">        const config = json &amp;&amp; JSON.parse(json);</span><br><span class="line">        module = config &amp;&amp; BatchedBridge.processModuleConfig(config, module.moduleID);</span><br><span class="line">        RemoteModules[moduleName] = module;</span><br><span class="line">      &#125;</span><br><span class="line">      return module;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå‡å¦‚ä½ åœ¨jså±‚æ²¡æœ‰ä½¿ç”¨åˆ°nativeæ¨¡å—ï¼Œé‚£ä¹ˆè¿™äº›æ¨¡å—æ˜¯ä¸ä¼šåŠ è½½åˆ°jså±‚çš„ï¼Œåªæœ‰ä½¿ç”¨åˆ°äº†è¯¥æ¨¡å—ï¼Œreactæ‰ä¼šå»è·å–è¯¥æ¨¡å—çš„å…·ä½“é…ç½®ä¿¡æ¯ç„¶ååŠ è½½åˆ°js,è¿™æ˜¯reactæ‡’åŠ è½½çš„ä¸€ä¸ªæ–¹å¼ï¼Œè®©æˆ‘ä»¬èƒ½å¤ŸèŠ‚çº¦å†…å­˜,è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•è·å–æ¨¡å—çš„é…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//åªä¼šå¯¼å‡ºæœ‰__rct_export__å‰ç¼€çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰RCT_EXPORT_METHODè¿™ä¸ªå®å®šä¹‰æåˆ°çš„</span><br><span class="line">- (NSArray&lt;id&lt;RCTBridgeMethod&gt;&gt; *)methods</span><br><span class="line">&#123;</span><br><span class="line">  //æ‹·è´è¯¥ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åè¿‡æ»¤ä»¥__rct_export__å¼€å¤´çš„æ–¹æ³•</span><br><span class="line">  Method *methods = class_copyMethodList(object_getClass(_moduleClass), &amp;methodCount);</span><br><span class="line">  for (unsigned int i = 0; i &lt; methodCount; i++) &#123;</span><br><span class="line">    Method method = methods[i];</span><br><span class="line">    SEL selector = method_getName(method);</span><br><span class="line">    if ([NSStringFromSelector(selector) hasPrefix:@&quot;__rct_export__&quot;]) &#123;</span><br><span class="line">      IMP imp = method_getImplementation(method);</span><br><span class="line">      NSArray&lt;NSString *&gt; *entries =</span><br><span class="line">        ((NSArray&lt;NSString *&gt; *(*)(id, SEL))imp)(_moduleClass, selector);</span><br><span class="line"></span><br><span class="line">      [moduleMethods addObject:/*ä»£è¡¨è¯¥æ–¹æ³•çš„å¯¹è±¡*/];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è·å–æ¨¡å—çš„å…·ä½“é…ç½®ä¿¡æ¯ï¼Œä»¥æ•°ç»„å½¢å¼è¿”å›ï¼Œç¬¬ä¸€ä¸ªä¸ºæ¨¡å—åç§°ï¼Œç¬¬äºŒä¸ªä¸ºéœ€è¦å¯¼å‡ºçš„å¸¸é‡ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç¬¬ä¸‰ä¸ªä¸ºå¯¼å‡ºçš„æ–¹æ³•ï¼ˆå¦‚æœæœ‰ï¼‰</span><br><span class="line">//ä»¥MyModuleä¸ºä¾‹ï¼Œå¯¼å‡ºçš„configä¸ºï¼š[&quot;MyModule&quot;,&#123;&quot;FirstDay&quot;:&quot;Monday&quot;&#125;,[&quot;addEvent&quot;,&quot;findEvents&quot;]]</span><br><span class="line">- (NSArray *)config</span><br><span class="line">&#123;</span><br><span class="line">  //è¿‡æ»¤è·å–ä»¥__rct_export__å¼€å¤´çš„æ–¹æ³•</span><br><span class="line">  for (id&lt;RCTBridgeMethod&gt; method in self.methods) &#123;</span><br><span class="line">    [methods addObject:method.JSMethodName];</span><br><span class="line">  &#125;</span><br><span class="line">  NSMutableArray *config = [NSMutableArray new];</span><br><span class="line">  [config addObject:self.name];</span><br><span class="line">  if (constants.count) &#123;</span><br><span class="line">    [config addObject:constants];</span><br><span class="line">  &#125;</span><br><span class="line">  if (methods) &#123;</span><br><span class="line">    [config addObject:methods];</span><br><span class="line">  &#125;</span><br><span class="line">  return config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¼å‡ºçš„é…ç½®ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°configé‡ŒåŒ…å«çš„æ¨¡å—åç§°ï¼Œå¯¼å‡ºçš„å¸¸é‡ä»¥åŠå¯¼å‡ºçš„å‡½æ•°ç­‰ï¼Œæ¨èé€šè¿‡è°ƒè¯•å·¥å…·<a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi" target="_blank" rel="external">React Developer Tools</a>æ‰“æ–­ç‚¹æ¥æŸ¥çœ‹ï¼š<br><img src="http://7xpjm0.com1.z0.glb.clouddn.com/458529-55517b729679058d.png" alt="__fbBatchedBridgeConfig"></p>
<ul>
<li>BatchedBridge</li>
</ul>
<p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡è·å–åˆ°æ¨¡å—çš„å…·ä½“é…ç½®ä¿¡æ¯ä¹‹åä¼šäº¤ç»™BatchedBridgeå¤„ç†ï¼Œä¹‹å‰æˆ‘ä»¬è¯´çš„æ˜¯nativeçš„bridgeï¼Œä¸è¿‡jsä¸ºäº†æ¡¥æ¥nativeå±‚ä¹Ÿå¼•å…¥äº†BatchedBridgeï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//BatchedBridge.js</span><br><span class="line">const MessageQueue = require(&apos;MessageQueue&apos;);</span><br><span class="line">const BatchedBridge = new MessageQueue(</span><br><span class="line">  __fbBatchedBridgeConfig.remoteModuleConfig,</span><br><span class="line">  __fbBatchedBridgeConfig.localModulesConfig,</span><br><span class="line">);</span><br><span class="line">//å°†BatchedBridgeæ·»åŠ åˆ°jsçš„å…¨å±€globalå¯¹è±¡ä¸­ï¼Œ</span><br><span class="line">Object.defineProperty(global, &apos;__fbBatchedBridge&apos;, &#123; value: BatchedBridge &#125;);</span><br><span class="line">module.exports = BatchedBridge;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹åˆ°BatchedBridgeæ˜¯MessageQueueçš„ä¸€ä¸ªå®ä¾‹ï¼Œè€Œä¸”æ˜¯å…¨å±€å”¯ä¸€çš„ä¸€ä¸ªå®ä¾‹ï¼Œä½œä¸ºæ¡¥æ¥nativeçš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œæˆ‘ä»¬æ¥å…·ä½“æ·±å…¥çœ‹ä¸€ä¸‹å®ƒçš„å†…éƒ¨å®ç°â€œã€‚</p>
<p>çœ‹ä¸€ä¸‹ä¼ é€’ç»™messageQueueçš„ä¸¤ä¸ªå‚æ•°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__fbBatchedBridgeConfig.remoteModuleConfig,</span><br><span class="line">__fbBatchedBridgeConfig.localModulesConfig,</span><br></pre></td></tr></table></figure></p>
<p> <strong>fbBatchedBridgeConfigæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€çš„jså˜é‡ï¼Œ</strong>fbBatchedBridgeConfig.remoteModuleConfigå°±æ˜¯ä¹‹å‰æˆ‘ä»¬åœ¨nativeå±‚å¯¼å‡ºçš„æ¨¡å—é…ç½®è¡¨.</p>
<h6 id="messageQueue"><a href="#messageQueue" class="headerlink" title="messageQueue"></a>messageQueue</h6><p>é¦–å…ˆçœ‹ä¸€ä¸‹messageQueueé‡Œçš„ä¸€äº›å®ä¾‹å˜é‡ä»¥åŠAPI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//å­˜å‚¨nativeæä¾›çš„å„ä¸ªæ¨¡å—ä¿¡æ¯ï¼Œ</span><br><span class="line">this.RemoteModules = &#123;&#125;;</span><br><span class="line">//å­˜å‚¨jsæä¾›çš„å„ä¸ªæ¨¡å—ä¿¡æ¯</span><br><span class="line">this._callableModules = &#123;&#125;;</span><br><span class="line">//ç”¨äºå­˜æ”¾è°ƒç”¨ä¿¡æ¯é˜Ÿåˆ—ï¼Œæœ‰ä¸‰ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«å¯¹åº”è°ƒç”¨çš„æ¨¡å—ï¼Œè°ƒç”¨çš„å‡½æ•°å’Œå‚æ•°ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ç”±è¿™ä¸‰ä¸ªæ•°ç»„æ‹¼æ¥è€Œæˆ</span><br><span class="line">this._queue = [[], [], [], 0];</span><br><span class="line">//ä»¥moduleIDä¸ºkeyï¼Œvalueä¸ºmoduleNameï¼Œé’ˆå¯¹jsæä¾›çš„module</span><br><span class="line">this._moduleTable = &#123;&#125;;</span><br><span class="line">//ä»¥moduleIdä¸ºkeyï¼Œvalueä¸ºæ¨¡å—å¯¼å‡ºçš„æ–¹æ³•ï¼Œé’ˆå¯¹jsæä¾›çš„module</span><br><span class="line">this._methodTable = &#123;&#125;;</span><br><span class="line">//å›è°ƒå‡½æ•°æ•°ç»„</span><br><span class="line">this._callbacks = [];</span><br><span class="line">//å›è°ƒå‡½æ•°å¯¹åº”çš„ç´¢å¼•id</span><br><span class="line">this._callbackID = 0;</span><br><span class="line"></span><br><span class="line">let modulesConfig = this._genModulesConfig(remoteModules);</span><br><span class="line">this._genModules(modulesConfig);</span><br><span class="line">localModules &amp;&amp; this._genLookupTables(</span><br><span class="line">  this._genModulesConfig(localModules),this._moduleTable, this._methodTable</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">//ä»¥moduleIdä¸ºkeyï¼Œvalueä¸ºmoduleNameï¼Œé’ˆå¯¹nativeæä¾›çš„module</span><br><span class="line">this._remoteModuleTable = &#123;&#125;;</span><br><span class="line">//ä»¥moduleIdä¸ºkeyï¼Œvalueä¸ºæ¨¡å—å¯¼å‡ºçš„æ–¹æ³•ï¼Œé’ˆå¯¹nativeæä¾›module</span><br><span class="line">this._remoteMethodTable = &#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªé˜Ÿåˆ—é‡Œä¿å­˜ç€jsè·Ÿnativeçš„æ¨¡å—äº¤äº’çš„æ‰€æœ‰ä¿¡æ¯ã€‚å…ˆçœ‹ä¸€ä¸‹_genModulesæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šæ ¹æ®configè§£ææ¯ä¸ªæ¨¡å—çš„ä¿¡æ¯å¹¶ä¿å­˜åˆ°this.RemoteModulesä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_genModules(remoteModules) &#123;</span><br><span class="line">  remoteModules.forEach((config, moduleID) =&gt; &#123;</span><br><span class="line">    this._genModule(config, moduleID);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_genModulesä¼šå†éæ‰€æœ‰çš„remoteModules,æ ¹æ®æ¯ä¸ªæ¨¡å—çš„é…ç½®ä¿¡æ¯(å¦‚ä½•ç”Ÿæˆé…ç½®ä¿¡æ¯ä¸‹é¢ä¼šæåˆ°)å’Œmoduleç´¢å¼•IDæ¥åˆ›å»ºæ¯ä¸ªæ¨¡å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_genModule(config, moduleID) &#123;</span><br><span class="line">  let moduleName, constants, methods, asyncMethods;</span><br><span class="line">  //é€šè¿‡è§£æ„èµ‹å€¼çš„æ–¹å¼æå–é…ç½®ä¿¡æ¯ä¸­çš„æ¨¡å—åç§°ï¼Œå¸¸é‡(å¦‚æœæœ‰)ï¼Œæ–¹æ³•åç­‰</span><br><span class="line">  [moduleName, constants, methods, asyncMethods] = config;</span><br><span class="line">  let module = &#123;&#125;;</span><br><span class="line">  methods &amp;&amp; methods.forEach((methodName, methodID) =&gt; &#123;</span><br><span class="line">    //å†éè¯¥configä¸­çš„æ–¹æ³•åˆ—è¡¨ï¼Œæ ¹æ®é…ç½®ä¿¡æ¯ä¸ºæ¯ä¸ªæ¨¡å—ç”Ÿæˆjs functionæ–¹æ³•å¹¶æ·»åŠ åˆ°moduleå¯¹è±¡ï¼Œ</span><br><span class="line">    module[methodName] = this._genMethod(moduleID, methodID, methodType);</span><br><span class="line">  &#125;);</span><br><span class="line">  //å¸¸é‡ä¿¡æ¯assignåˆ°è¯¥moduleå¯¹è±¡,å¹¶å°†moduleä¿å­˜åˆ°this.RemoteModulesä¸­</span><br><span class="line">  Object.assign(module, constants);</span><br><span class="line">  this.RemoteModules[moduleName] = module;</span><br><span class="line">  return module;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_genMethodæ–¹æ³•å¦‚ä¸‹ï¼Œå‡å¦‚æ–¹æ³•çš„typeä¸ºremoteAsyncï¼Œä¹Ÿå°±æ˜¯å¼‚æ­¥æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯ç”¨ä¸€ä¸ªpromiseå¯¹è±¡(promiseæ˜¯jsä¸­çš„ä¸€ç§å¼‚æ­¥ç¼–ç¨‹æ–¹å¼)æ¥åŒ…è£…æ™®é€šçš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬åªçœ‹ä¸‹æ™®é€šæ–¹æ³•çš„å¤„ç†è¿‡ç¨‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">_genMethod(module, method, type) &#123;</span><br><span class="line">  let fn = null;</span><br><span class="line">  let self = this;</span><br><span class="line">  fn = function(...args) &#123;</span><br><span class="line">  let lastArg = args.length &gt; 0 ? args[args.length - 1] : null;</span><br><span class="line">  let secondLastArg = args.length &gt; 1 ? args[args.length - 2] : null;</span><br><span class="line">  let hasSuccCB = typeof lastArg === &apos;function&apos;;</span><br><span class="line">  let hasErrorCB = typeof secondLastArg === &apos;function&apos;;</span><br><span class="line">  hasErrorCB &amp;&amp; invariant(</span><br><span class="line">    hasSuccCB,</span><br><span class="line">    &apos;Cannot have a non-function arg after a function arg.&apos;</span><br><span class="line">  );</span><br><span class="line">  let numCBs = hasSuccCB + hasErrorCB;</span><br><span class="line">  let onSucc = hasSuccCB ? lastArg : null;</span><br><span class="line">  let onFail = hasErrorCB ? secondLastArg : null;</span><br><span class="line">  args = args.slice(0, args.length - numCBs);</span><br><span class="line">  return self.__nativeCall(module, method, args, onFail, onSucc);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  fn.type = type;</span><br><span class="line">  return fn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯åœ¨å‚æ•°åˆ—è¡¨ä¸­æå–onFailå’ŒonSuccå›è°ƒå‡½æ•°ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨__nativeCallæ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  __nativeCall(module, method, params, onFail, onSucc) &#123;</span><br><span class="line">    if (onFail || onSucc) &#123;</span><br><span class="line">      onFail &amp;&amp; params.push(this._callbackID);</span><br><span class="line">      this._callbacks[this._callbackID++] = onFail;</span><br><span class="line">      onSucc &amp;&amp; params.push(this._callbackID);</span><br><span class="line">      this._callbacks[this._callbackID++] = onSucc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this._queue[MODULE_IDS].push(module);</span><br><span class="line">    this._queue[METHOD_IDS].push(method);</span><br><span class="line">    this._queue[PARAMS].push(params);</span><br><span class="line"></span><br><span class="line">    var now = new Date().getTime();</span><br><span class="line">    //å½“ä¸¤æ¬¡è°ƒç”¨é—´éš”è¿‡å°çš„æ—¶å€™åªæ˜¯å…ˆç¼“å­˜è°ƒç”¨ä¿¡æ¯</span><br><span class="line">    if (global.nativeFlushQueueImmediate &amp;&amp;</span><br><span class="line">        now - this._lastFlush &gt;= MIN_TIME_BETWEEN_FLUSHES_MS) &#123;</span><br><span class="line">      global.nativeFlushQueueImmediate(this._queue);</span><br><span class="line">      this._queue = [[], [], [], this._callID];</span><br><span class="line">      this._lastFlush = now;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">//RCTJSCExecutor.m</span><br><span class="line">  [self addSynchronousHookWithName:@&quot;nativeFlushQueueImmediate&quot; usingBlock:^(NSArray&lt;NSArray *&gt; *calls)&#123;</span><br><span class="line">    [strongSelf-&gt;_bridge handleBuffer:calls batchEnded:NO];</span><br><span class="line">  &#125;];</span><br></pre></td></tr></table></figure>
<p>__nativeCallæ–¹æ³•ä¸­ï¼Œå‡å¦‚æœ‰å›è°ƒå‚æ•°onFailæˆ–onSuccï¼Œä¼šå°†å¯¹åº”çš„callbackIDä¿å­˜åˆ°å‚æ•°ä¸­ï¼Œå¹¶å°†å®ƒä»¬å‹å…¥åˆ°_callbacksæ ˆä¸­ï¼›æ¥ç€å°†æ¨¡å—ï¼Œåç§°ä»¥åŠå‚æ•°åˆ†åˆ«ä¿å­˜åˆ°_queueçš„ä¸‰ä¸ªæ•°ç»„ä¸­ï¼›æ¥ä¸‹æ¥çš„å…³é”®å°±æ˜¯è°ƒç”¨nativeFlushQueueImmediateæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ä¹‹å‰RCTJSCExecutor setupçš„æ—¶å€™æ³¨å†Œåˆ°js globalçš„æ–¹æ³•ï¼Œå› æ­¤å®ƒä¼šæ‰§è¡Œç›¸åº”çš„native blockæ–¹æ³•(javascriptcoreæ¡†æ¶ä¼šè´Ÿè´£js functionå’Œblockçš„è½¬æ¢)ï¼Œå¯ä»¥çœ‹å‡º_queueä¸­çš„æ¨¡å—ã€æ–¹æ³•ä»¥åŠå‚æ•°ä¿¡æ¯æœ€ç»ˆä¼šä¼ é€’ç»™nativeå±‚ï¼Œç”±nativeè§£æå¹¶æ‰§è¡Œç›¸åº”çš„nativeæ–¹æ³•ã€‚<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ³¨æ„åˆ°è¿™é‡Œreactä¸ºäº†æ€§èƒ½çš„ä¼˜åŒ–ï¼Œå½“jsä¸¤æ¬¡è°ƒç”¨æ–¹æ³•çš„é—´éš”å°äºMIN_TIME_BETWEEN_FLUSHES_MS(5ms)æ—¶é—´ï¼Œä¼šå°†è°ƒç”¨ä¿¡æ¯å…ˆç¼“å­˜åˆ°_queueä¸­ï¼Œç­‰å¾…ä¸‹æ¬¡åœ¨ä¸€å¹¶æäº¤ç»™nativeå±‚æ‰§è¡Œï¼Œå¯èƒ½è¿™ä¹Ÿå°±æ˜¯è¿™äº›å‚æ•°è®¾ç½®æˆæ•°ç»„å½¢å¼ä¿å­˜çš„åŸå› ã€‚</p>
<p>è®©æˆ‘ä»¬åœ¨æ¥ä¸‹å»çœ‹çœ‹handleBufferï¼ŒhandleBufferä¼šå°†è°ƒç”¨ä¿¡æ¯å…ˆæŒ‰æ¨¡å—çš„é˜Ÿåˆ—åˆ†å¥½ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">//RCTBatchedBridge.m</span><br><span class="line">- (void)handleBuffer:(id)buffer batchEnded:(BOOL)batchEnded</span><br><span class="line">&#123;</span><br><span class="line">  NSArray *requestsArray = [RCTConvert NSArray:buffer];</span><br><span class="line">  //å…ˆå°†messageueueä¼ é€’çš„å‚æ•°æå–å‡ºæ¥åˆ†åˆ«æ”¾åˆ°moduleIDsã€methodIDså’ŒparamsArraysæ•°ç»„ä¸­ï¼Œ</span><br><span class="line">  NSArray&lt;NSNumber *&gt; *moduleIDs = [RCTConvert NSNumberArray:requestsArray[RCTBridgeFieldRequestModuleIDs]];</span><br><span class="line">  NSArray&lt;NSNumber *&gt; *methodIDs = [RCTConvert NSNumberArray:requestsArray[RCTBridgeFieldMethodIDs]];</span><br><span class="line">  NSArray&lt;NSArray *&gt; *paramsArrays = [RCTConvert NSArrayArray:requestsArray[RCTBridgeFieldParamss]];</span><br><span class="line"></span><br><span class="line">  //å°†è°ƒç”¨çš„ä¿¡æ¯å…ˆå®‰æ¨¡å—å„è‡ªæŒ‡å®šçš„é˜Ÿåˆ—åˆ†å¥½</span><br><span class="line">  NSMapTable *buckets = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory</span><br><span class="line">                                                  valueOptions:NSPointerFunctionsStrongMemory</span><br><span class="line">                                                      capacity:_moduleDataByName.count];</span><br><span class="line">  [moduleIDs enumerateObjectsUsingBlock:^(NSNumber *moduleID, NSUInteger i, __unused BOOL *stop) &#123;</span><br><span class="line">    RCTModuleData *moduleData = _moduleDataByID[moduleID.integerValue];</span><br><span class="line">    dispatch_queue_t queue = moduleData.methodQueue;</span><br><span class="line">    if (!set) &#123;</span><br><span class="line">      set = [NSMutableOrderedSet new];</span><br><span class="line">      [buckets setObject:set forKey:moduleData.methodQueue];</span><br><span class="line">    &#125;</span><br><span class="line">    [set addObject:@(i)];</span><br><span class="line">  &#125;];</span><br><span class="line">  //æŒ‰é˜Ÿåˆ—æ¥æ‰¹é‡æ‰§è¡Œç›¸åº”çš„è°ƒç”¨</span><br><span class="line">  for (dispatch_queue_t queue in buckets) &#123;</span><br><span class="line">    dispatch_block_t block = ^&#123;</span><br><span class="line">      RCTProfileEndFlowEvent();</span><br><span class="line">      NSOrderedSet *calls = [buckets objectForKey:queue];</span><br><span class="line">      @autoreleasepool &#123;</span><br><span class="line">        for (NSNumber *indexObj in calls) &#123;</span><br><span class="line">          NSUInteger index = indexObj.unsignedIntegerValue;</span><br><span class="line">          //åœ¨å„è‡ªæ¨¡å—ä¸Šæ ¹æ®å‚æ•°æ‰§è¡ŒæŒ‡å®šçš„æ–¹æ³•</span><br><span class="line">          [self _handleRequestNumber:index</span><br><span class="line">                            moduleID:[moduleIDs[index] integerValue]</span><br><span class="line">                            methodID:[methodIDs[index] integerValue]</span><br><span class="line">                              params:paramsArrays[index]];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    if (queue == RCTJSThread) &#123;</span><br><span class="line">      [_javaScriptExecutor executeBlockOnJavaScriptQueue:block];</span><br><span class="line">    &#125; else if (queue) &#123;</span><br><span class="line">      dispatch_async(queue, block);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_handleRequestNumberæ ¹æ®æ¨¡å—çš„IDã€æ–¹æ³•IDä»¥åŠå‚æ•°æ¥è°ƒç”¨å…·ä½“çš„å‡½æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)_handleRequestNumber:(NSUInteger)i</span><br><span class="line">                    moduleID:(NSUInteger)moduleID</span><br><span class="line">                    methodID:(NSUInteger)methodID</span><br><span class="line">                      params:(NSArray *)params</span><br><span class="line">&#123;</span><br><span class="line">  RCTModuleData *moduleData = _moduleDataByID[moduleID];</span><br><span class="line">  id&lt;RCTBridgeMethod&gt; method = moduleData.methods[methodID];</span><br><span class="line">  [method invokeWithBridge:self module:moduleData.instance arguments:params];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­å¦‚ä½•æ ¹æ®å‡½æ•°ç­¾åæ¥è°ƒç”¨å‡½æ•°å¯ä»¥å…·ä½“æŸ¥é˜…-(void)processMethodSignatureå‡½æ•°ï¼Œè¿™é‡Œå°±ä¸å»ç»†è°ˆäº†ã€‚</p>
<ul>
<li>å›è°ƒå‡½æ•°<br>å½“æœ‰å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œä¹‹å‰çœ‹åˆ°__nativeCallä¼šå°†callbackIDæ”¾ç½®åœ¨å‚æ•°ä¸­ï¼Œå¯¹åº”çš„å›è°ƒå‡½æ•°æ’å…¥åˆ°_callbacksä¸­ä¿å­˜ï¼Œjså°†è¯¥IDä¼ é€’ç»™nativeï¼Œnativeå°±æ˜¯é€šè¿‡è¯¥IDæ¥æ‰¾åˆ°å¯¹åº”çš„å›è°ƒå‡½æ•°çš„ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//MyModule.m</span><br><span class="line">RCT_EXPORT_METHOD(findEvents:(RCTResponseSenderBlock)callback)</span><br><span class="line">&#123;</span><br><span class="line">  NSArray *events = @[@&quot;test1&quot;,@&quot;test2&quot;,@&quot;test3&quot;];</span><br><span class="line">  callback(@[[NSNull null], events]);</span><br><span class="line">&#125;</span><br><span class="line">//ç”Ÿæˆçš„å‡½æ•°ç­¾å</span><br><span class="line">findEvents:(RCTResponseSenderBlock)callback</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚MyModuleå®šä¹‰çš„å›è°ƒå‡½æ•°ï¼Œå½“é€šè¿‡å‡½æ•°ç­¾åå¦‚æœå‘ç°å‚æ•°çš„ç±»å‹æ˜¯RCTResponseSenderBlockï¼Œåˆ™jsä¼ é€’è¿‡æ¥çš„å‚æ•°å°±æ˜¯å›è°ƒå‡½æ•°çš„IDï¼Œnativeå±‚å°±ä¼šæ ¹æ®è¯¥IDä»¥åŠRCTResponseSenderBlockæä¾›çš„å‚æ•°æ¥å›è°ƒç›¸åº”çš„jså›è°ƒå‡½æ•°ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å¯ä»¥ç®€å•çš„ç”¨ä¸‹å›¾è¡¨ç¤ºã€‚</p>
<p><img src="http://7xpjm0.com1.z0.glb.clouddn.com/458529-55bd1d087f5b19af.png" alt="è°ƒç”¨è¿‡ç¨‹"></p>
<h4 id="Native-gt-JSï¼ŒNativeè°ƒç”¨JS"><a href="#Native-gt-JSï¼ŒNativeè°ƒç”¨JS" class="headerlink" title="Native-&gt;JSï¼ŒNativeè°ƒç”¨JS"></a>Native-&gt;JSï¼ŒNativeè°ƒç”¨JS</h4><p>å‡å¦‚ä½ æœ‰è‡ªå·±åˆ›å»ºçš„jsæ¨¡å—æƒ³è¦è¢«nativeå±‚è°ƒç”¨ï¼Œä¹Ÿéœ€è¦å°†è¯¥jsæ¨¡å—æ³¨å†Œæ·»åŠ åˆ°messagequeueçš„_callableModulesä¸­ï¼Œæ¯”å¦‚reactjsçš„äº‹ä»¶å‘é€æ¨¡å—ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//RCTEventEmitter.js</span><br><span class="line">BatchedBridge.registerCallableModule(</span><br><span class="line">  &apos;RCTEventEmitter&apos;,</span><br><span class="line">  ReactNativeEventEmitter</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p><img src="http://7xpjm0.com1.z0.glb.clouddn.com/bbbbb.png" alt="æ³¨å†Œjsæ¨¡å—"><br>nativeå±‚è°ƒç”¨çš„jsæ–¹æ³•ç±»ä¼¼å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Â  [_bridge enqueueJSCall:@&quot;RCTEventEmitter.receiveEvent&quot;</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  args:body ? @[body[@&quot;target&quot;], name, body] : @[body[@&quot;target&quot;], name]];</span><br></pre></td></tr></table></figure></p>
<p>ä¸è¿‡è®©æˆ‘ä»¬æ¥çœ‹çœ‹çœŸæ­£æ‰§è¡Œjsä»£ç çš„åœ°æ–¹ï¼Œé‡Œé¢å…¶å®å°±æ˜¯ç”¨åˆ°javascriptcoreæ¡†æ¶ï¼Œä¸ºäº†æ–¹ä¾¿æ–­ç‚¹è°ƒè¯•æˆ‘æŠŠå®å»æ‰äº†ï¼Œä¸è¿‡ä¸å½±å“ï¼Œç®€å•ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (void)_executeJSCall:(NSString *)method</span><br><span class="line">Â Â  Â  Â  Â  Â  Â  arguments:(NSArray *)arguments</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  callback:(RCTJavaScriptCallback)onComplete</span><br><span class="line">&#123;</span><br><span class="line">Â  dispatch_block_t myBlock = ^&#123;</span><br><span class="line">Â  Â  JSGlobalContextRef contextJSRef = JSContextGetGlobalContext(strongSelf-&gt;_context.ctx);</span><br><span class="line">Â  Â  JSObjectRef globalObjectJSRef = JSContextGetGlobalObject(strongSelf-&gt;_context.ctx);</span><br><span class="line">Â Â  Â </span><br><span class="line">Â  Â  //ä»jsçš„å…¨å±€å¯¹è±¡ä¸­è·å–BatchedBridgeå¯¹è±¡</span><br><span class="line">Â  Â  JSStringRef moduleNameJSStringRef = JSStringCreateWithUTF8CString(&quot;__fbBatchedBridge&quot;);</span><br><span class="line">Â  Â  JSValueRef moduleJSRef = JSObjectGetProperty(contextJSRef, globalObjectJSRef, moduleNameJSStringRef, &amp;errorJSRef);</span><br><span class="line">Â  Â  JSStringRelease(moduleNameJSStringRef)</span><br><span class="line">Â  Â  if (moduleJSRef != NULL &amp;&amp; errorJSRef == NULL &amp;&amp; !JSValueIsUndefined(contextJSRef, moduleJSRef)) &#123;</span><br><span class="line">Â  Â  Â  //è·å–jså¯¹è±¡ç›¸åº”çš„æ–¹æ³•</span><br><span class="line">Â  Â  Â  JSStringRef methodNameJSStringRef = JSStringCreateWithCFString((__bridge CFStringRef)method);</span><br><span class="line">Â  Â  Â  JSValueRef methodJSRef = JSObjectGetProperty(contextJSRef, (JSObjectRef)moduleJSRef, methodNameJSStringRef, &amp;errorJSRef);</span><br><span class="line">Â  Â  Â  JSStringRelease(methodNameJSStringRef);</span><br><span class="line">Â  Â  Â  if (methodJSRef != NULL &amp;&amp; errorJSRef == NULL &amp;&amp; !JSValueIsUndefined(contextJSRef, methodJSRef)) &#123;</span><br><span class="line">Â  Â  Â  Â  // è°ƒç”¨ç›¸åº”çš„jså‡½æ•°</span><br><span class="line">Â  Â  Â  Â  if (arguments.count == 0) &#123;</span><br><span class="line">Â  Â  Â  Â  Â  resultJSRef = JSObjectCallAsFunction(contextJSRef, (JSObjectRef)methodJSRef, (JSObjectRef)moduleJSRef, 0, NULL, &amp;errorJSRef);</span><br><span class="line">Â  Â  Â  Â  &#125;</span><br><span class="line">Â  &#125;;</span><br><span class="line">Â  [self executeBlockOnJavaScriptQueue:myBlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºnativeè°ƒç”¨jsçš„ä»£ç å€ŸåŠ©JavaScriptCoreæ¡†æ¶å˜çš„éå¸¸ç®€å•ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>ä¸Šé¢ç®€å•çš„è¯´æ˜äº†reactä¹‹é—´çš„é€šä¿¡è¿‡ç¨‹ï¼Œè‡³äºè·Ÿviewç›¸å…³çš„å†…å®¹ä¸‹æ¬¡åœ¨è®¨è®ºï¼Œè¿™ä¸ªå…¶å®æ‰æ˜¯reactæ¯”è¾ƒé‡è¦çš„å†…å®¹ï¼Œå¦‚æœæœ‰å…´è¶£æ¬¢è¿ä¸€èµ·äº¤æµï½</p>
<p>###å‚è€ƒ </p>
<ul>
<li><a href="http://facebook.github.io/react-native/" target="_blank" rel="external">http://facebook.github.io/react-native/</a></li>
<li><a href="http://tadeuzagallo.com/blog/react-native-bridge/" target="_blank" rel="external">http://tadeuzagallo.com/blog/react-native-bridge/</a></li>
</ul>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/æºç è§£æ/" rel="tag">#æºç è§£æ</a>
          
            <a href="/tags/ReactNative/" rel="tag">#ReactNative</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/01/è¯´è¯´JavaScriptCore/" rel="next" title="è¯´è¯´JavaScriptCore">
                <i class="fa fa-chevron-left"></i> è¯´è¯´JavaScriptCore
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/"
           data-title="æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰" data-url="http://freemind-lj.github.io/2016/03/14/æµ…æReactä¹‹é€šä¿¡æœºåˆ¶ï¼ˆä¸€ï¼‰/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="æ ‘ä¸‹çš„è€ç”·å­©" />
          <p class="site-author-name" itemprop="name">æ ‘ä¸‹çš„è€ç”·å­©</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#JS-gt-Nativeï¼ŒJSè°ƒç”¨Native"><span class="nav-number">1.</span> <span class="nav-text">JS->Nativeï¼ŒJSè°ƒç”¨Native</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#initModules"><span class="nav-number">1.1.</span> <span class="nav-text">initModules</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#setUpExecutor"><span class="nav-number">1.2.</span> <span class="nav-text">setUpExecutor</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#moduleConfig"><span class="nav-number">1.3.</span> <span class="nav-text">moduleConfig</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#injectJSONConfiguration"><span class="nav-number">1.4.</span> <span class="nav-text">injectJSONConfiguration</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#messageQueue"><span class="nav-number">1.5.</span> <span class="nav-text">messageQueue</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Native-gt-JSï¼ŒNativeè°ƒç”¨JS"><span class="nav-number"></span> <span class="nav-text">Native->JSï¼ŒNativeè°ƒç”¨JS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number"></span> <span class="nav-text">æ€»ç»“</span></a></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æ ‘ä¸‹çš„è€ç”·å­©</span>
  <span id="busuanzi_container_site_pv">|  æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
  </span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="http://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces  
  </a> 
  
</div>









      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=0.5.0"></script>



  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"treeboy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("DvWhe5PSPJP5bPXSjWLCB0mj-gzGzoHsz", "TTKtGStuW0SPbCbajWcG5w5W");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>




</body>
</html>
